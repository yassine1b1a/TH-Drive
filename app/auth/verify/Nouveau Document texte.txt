'use client'

import { useState, useEffect } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { Loader2, Mail, CheckCircle, AlertCircle, RefreshCw, ArrowLeft } from 'lucide-react'

export default function VerifyPage() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const [email, setEmail] = useState('')
  const [loading, setLoading] = useState(false)
  const [message, setMessage] = useState<string | null>(null)
  const [error, setError] = useState<string | null>(null)
  const [isVerified, setIsVerified] = useState(false)
  const [checkingStatus, setCheckingStatus] = useState(false)

  // Get message from URL
  const urlMessage = searchParams.get('message')

  // Initialize email from localStorage or URL
  useEffect(() => {
    const storedEmail = localStorage.getItem('unverified_email')
    if (storedEmail) {
      setEmail(storedEmail)
    }
    
    // Set initial message based on URL parameter
    if (urlMessage === 'check_email') {
      setMessage('Please check your email for the verification link.')
    } else if (urlMessage === 'verification_resent') {
      setMessage('A new verification email has been sent to your inbox.')
    } else if (urlMessage === 'verify_to_continue') {
      setMessage('Please verify your email to continue to the dashboard.')
    } else if (urlMessage === 'complete_verification') {
      setMessage('Click the verification link in your email to complete sign up.')
    }
  }, [urlMessage])

  // Check verification status on mount
  useEffect(() => {
    const checkVerification = async () => {
      const supabase = createClient()
      const { data: { session } } = await supabase.auth.getSession()
      
      if (session?.user) {
        const { data: { user } } = await supabase.auth.getUser()
        if (user?.email_confirmed_at) {
          setIsVerified(true)
          setMessage('Your email is already verified!')
          localStorage.removeItem('unverified_email')
          
          // Redirect after 2 seconds
          setTimeout(() => {
            const role = session.user.user_metadata?.role || 'user'
            switch (role) {
              case 'driver':
                router.push('/driver/dashboard')
                break
              case 'admin':
              case 'moderator':
                router.push('/admin/dashboard')
                break
              default:
                router.push('/dashboard')
            }
          }, 2000)
        }
      }
    }

    checkVerification()
  }, [router])

  const handleResendVerification = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!email) {
      setError('Please enter your email address')
      return
    }

    setLoading(true)
    setError(null)
    setMessage(null)

    try {
      const supabase = createClient()
      
      // Store email in localStorage for persistence
      localStorage.setItem('unverified_email', email)
      
      // Try to resend verification email
      const { error: resendError } = await supabase.auth.resend({
        type: 'signup',
        email,
        options: {
          emailRedirectTo: `${window.location.origin}/auth/callback`,
        },
      })

      if (resendError) {
        // If resend fails, try sending a magic link instead
        if (resendError.message.includes('rate limit') || resendError.message.includes('already confirmed')) {
          const { error: otpError } = await supabase.auth.signInWithOtp({
            email,
            options: {
              emailRedirectTo: `${window.location.origin}/auth/callback`,
              shouldCreateUser: false,
            },
          })

          if (otpError) throw otpError
          setMessage('Magic link sent! Check your email to sign in.')
        } else {
          throw resendError
        }
      } else {
        setMessage('Verification email sent! Please check your inbox.')
      }
    } catch (err: any) {
      console.error('Resend error:', err)
      if (err.message.includes('already confirmed')) {
        setIsVerified(true)
        setMessage('Your email is already verified! Redirecting...')
        setTimeout(() => router.push('/auth/login'), 2000)
      } else if (err.message.includes('rate limit')) {
        setError('Please wait a few minutes before requesting another verification email.')
      } else {
        setError(err.message || 'Failed to send verification email. Please try again.')
      }
    } finally {
      setLoading(false)
    }
  }

  const handleCheckStatus = async () => {
    if (!email) {
      setError('Please enter your email address first')
      return
    }

    setCheckingStatus(true)
    setError(null)
    
    try {
      const supabase = createClient()
      const { data: { user }, error: userError } = await supabase.auth.getUser()
      
      if (userError) {
        // User not logged in, check via admin
        const { data: { users }, error: listError } = await supabase.auth.admin.listUsers()
        if (listError) throw listError
        
        const foundUser = users.find(u => u.email === email)
        if (foundUser?.email_confirmed_at) {
          setIsVerified(true)
          setMessage('Your email is verified! Please log in.')
          localStorage.removeItem('unverified_email')
          setTimeout(() => router.push('/auth/login'), 2000)
        } else {
          setError('Email not verified yet. Please check your inbox or resend verification.')
        }
      } else if (user?.email_confirmed_at) {
        setIsVerified(true)
        setMessage('Your email is verified! Redirecting...')
        localStorage.removeItem('unverified_email')
        
        // Redirect based on role
        const role = user.user_metadata?.role || 'user'
        setTimeout(() => {
          switch (role) {
            case 'driver':
              router.push('/driver/dashboard')
              break
            case 'admin':
            case 'moderator':
              router.push('/admin/dashboard')
              break
            default:
              router.push('/dashboard')
          }
        }, 2000)
      } else {
        setError('Email not verified yet. Please check your inbox.')
      }
    } catch (err: any) {
      console.error('Check status error:', err)
      setError('Unable to check verification status. Please try again.')
    } finally {
      setCheckingStatus(false)
    }
  }

  const clearEmailAndGoBack = () => {
    localStorage.removeItem('unverified_email')
    router.push('/auth/signup')
  }

  return (
    <div className="flex min-h-screen items-center justify-center bg-background p-4">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-primary/10">
            {isVerified ? (
              <CheckCircle className="h-6 w-6 text-green-600" />
            ) : (
              <Mail className="h-6 w-6 text-primary" />
            )}
          </div>
          <CardTitle className="text-2xl">
            {isVerified ? 'Email Verified!' : 'Verify Your Email'}
          </CardTitle>
          <CardDescription>
            {isVerified 
              ? 'Your email has been successfully verified.'
              : 'Please verify your email to continue using TH-Drive.'
            }
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          {message && (
            <Alert className="bg-green-50 text-green-800 border-green-200">
              <CheckCircle className="h-4 w-4" />
              <AlertDescription>{message}</AlertDescription>
            </Alert>
          )}

          {error && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          {!isVerified && (
            <>
              <form onSubmit={handleResendVerification} className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="email">Email Address</Label>
                  <Input
                    id="email"
                    type="email"
                    placeholder="you@example.com"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                    disabled={loading}
                  />
                  <p className="text-sm text-muted-foreground">
                    Enter the email you used to sign up
                  </p>
                </div>

                <div className="space-y-3">
                  <Button 
                    type="submit" 
                    className="w-full"
                    disabled={loading || !email}
                  >
                    {loading ? (
                      <>
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                        Sending...
                      </>
                    ) : (
                      <>
                        <RefreshCw className="mr-2 h-4 w-4" />
                        Resend Verification Email
                      </>
                    )}
                  </Button>
                  
                  <Button
                    type="button"
                    variant="outline"
                    onClick={handleCheckStatus}
                    disabled={checkingStatus || !email}
                    className="w-full"
                  >
                    {checkingStatus ? (
                      <>
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                        Checking...
                      </>
                    ) : (
                      'Check Verification Status'
                    )}
                  </Button>
                </div>
              </form>

              <div className="rounded-lg bg-muted p-4">
                <h4 className="font-semibold mb-2">Didn't receive the email?</h4>
                <ul className="text-sm text-muted-foreground space-y-1">
                  <li>• Check your spam or junk folder</li>
                  <li>• Make sure you entered the correct email</li>
                  <li>• Wait a few minutes and try again</li>
                  <li>• Contact support if the problem persists</li>
                </ul>
              </div>
            </>
          )}

          <div className="space-y-3">
            <Button
              variant="outline"
              onClick={() => router.push('/auth/login')}
              className="w-full"
            >
              <ArrowLeft className="mr-2 h-4 w-4" />
              Back to Login
            </Button>
            
            {!isVerified && (
              <Button
                variant="ghost"
                onClick={clearEmailAndGoBack}
                className="w-full"
              >
                Use Different Email
              </Button>
            )}
            
            <Button
              onClick={() => router.push('/')}
              className="w-full"
            >
              Go to Homepage
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}